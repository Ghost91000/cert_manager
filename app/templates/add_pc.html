{% extends "base.html" %}
{% block content %}
    <h1>Добавить пк</h1>

    <form>
        <input id="domain_name" type="text" placeholder="Название pc" required>
        <input id="aud" type="text" placeholder="aud" required>
        <input id="name" type="text" placeholder="user" required>
        <input id="phone" type="text" placeholder="phone">
        <input id="email" type="text" placeholder="email">
        <fieldset>
            <legend>Выберите сервисы:</legend>
            {% for service in services %}
                <div>
                    <input
                        type="checkbox"
                        id="service_{{ service.service_id }}"
                        name="service_ids"
                        value="{{ service.service_id }}"
                    >
                    <label for="service_{{ service.service_id }}" class="data_input">
                        {{ service.name }}
                        <small>({{ service.url }})</small>
                    </label>
                </div>
            {% endfor %}
        </fieldset>
        <fieldset>
            <legend>Выберите сертификаты:</legend>
            {% for cert in certs %}
                <div>
                    <input
                        type="checkbox"
                        id="cert_{{ cert.cert_id }}"
                        name="cert_ids"
                        value="{{ cert.cert_id }}"
                    >
                    <label for="cert_{{ cert.cert_id }}" class="data_input">
                        {{ cert.name }} <small>({{cert.person.name}})</small>
                    </label>
                </div>
            {% endfor %}
        </fieldset><br>
        <button id="btn_add" onclick="add()">Добавить</button>
    </form>
    <div id="list-pc">
        {% include "list_pc_partical.html" %}
    </div>
    <div style="margin-top: 20px;">
        <button onclick="refreshTable()">Обновить таблицу</button>
    </div>
    <br>
     <script>
         async function delete_pc(id) {
                const response = await fetch('/delete_pc', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `id=${encodeURIComponent(id)}`
                });
                refreshTable()
         }

        async function edit_pc(id){
            const response = await fetch(`/edit_pc/${id}`);
            const pc_data = await response.json();

            document.getElementById('domain_name').value = pc_data.domain_name;
            document.getElementById('aud').value = pc_data.aud;
            document.getElementById('name').value = pc_data.name;
            document.getElementById('phone').value = pc_data.phone;
            document.getElementById('email').value = pc_data.email;

            const checkboxes_serv = document.querySelectorAll('input[name="service_ids"]');
            const checkboxes_cert = document.querySelectorAll('input[name="cert_ids"]');
            checkboxes_serv.forEach(cb => {
                cb.checked = pc_data.service.includes(parseInt(cb.value))
            });
            checkboxes_cert.forEach(cb => {
                cb.checked = pc_data.cert.includes(parseInt(cb.value))
            });

            //document.getElementById('btn_add').textContent = "Изменить"

        }

        async function add() {
            const data = {
                domain_name: document.getElementById('domain_name').value,
                aud: document.getElementById('aud').value,
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                services: await getCheckedServices(),
                certs: await getCheckedCerts()
            }

            // Отправляем POST запрос
            const response = await fetch('/add_pc', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
                });

            //refreshTable()
        }

        async function getCheckedServices(){
            const checkboxes = document.querySelectorAll('input[name="service_ids"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            return selected;
        }

        async function getCheckedCerts(){
            const checkboxes = document.querySelectorAll('input[name="cert_ids"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            return selected;
        }

        // Функция обновления таблицы
        async function refreshTable() {
            const response = await fetch('/list_pc_partical');
            const html = await response.text();
            document.getElementById('list-pc').innerHTML = html;
        }
    </script>
{% endblock %}
