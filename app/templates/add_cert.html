{% extends "base.html" %}

{% block title %}Управление сертификатами{% endblock %}

{% block content %}
    <h1>Добавить сертификат</h1>

    <form>
        <input type="hidden" id="mode" value="add">
        <input type="hidden" id="edit_id" value="">

        <input id="name" type="text" placeholder="Название" required>
        <div class="data_input"><input id="date_from" type="date" placeholder="Date From" required></div>
        <div class="data_input"><input id="date_to" type="date" placeholder="Date To" required></div>
        <input id="version" type="text" placeholder="version" required>
        <select id="person_id">
          {% for person in persons %}
            <option value="{{ person.person_id }}">{{ person.name }}</option>
          {% endfor %}
        </select>
        <select id="org_id">
          {% for org in orgs %}
            <option value="{{ org.org_id }}">{{ org.name }}</option>
          {% endfor %}
        </select>
        <button id="btn_add" onclick="add()">Добавить</button>
        <button style="display: none; background-color: #dc3545" id="btn_clear" onclick="clearing()">Отмена</button>
    </form>
    <div id="list-cert">
        {% include "list_cert_partical.html" %}
    </div>
    <div style="margin-top: 20px;">
        <button onclick="refreshTable()">Обновить таблицу</button>
    </div>
    <br>

     <script>
         async function delete_cert(id) {
                const response = await fetch('/delete_cert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `id=${encodeURIComponent(id)}`
                });
                refreshTable()
         }


        async function edit_cert(id){
            const response = await fetch(`/edit_cert/${id}`);
            const data = await response.json();

            document.getElementById('name').value = data.name;
            document.getElementById('version').value = data.version;
            document.getElementById('date_from').value = data.date_from;
            document.getElementById('date_to').value = data.date_to;
            document.getElementById('person_id').value = data.person_id;
            document.getElementById('org_id').value = data.org_id;

            document.getElementById('btn_add').textContent = "Изменить";
            document.getElementById('mode').value = "edit";
            document.getElementById('edit_id').value = id;
            document.getElementById('btn_clear').style.display = 'inline-block';

        }

        async function add() {
            const data = {
                name: document.getElementById('name').value,
                version: document.getElementById('version').value,
                date_from: document.getElementById('date_from').value,
                date_to: document.getElementById('date_to').value,
                person_id: document.getElementById('person_id').value,
                org_id: document.getElementById('org_id').value
            }

            let url, method;
            let mode = document.getElementById('mode').value
            let edit_id = document.getElementById('edit_id').value

            if (mode === "add") {
                url = '/add_cert'
                method = 'POST'
            } else {
                url = `/edit_cert/${edit_id}`
                method = 'PUT'
            }

            // Отправляем POST запрос
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
                });

            refreshTable()

        }

        // Функция обновления таблицы
        async function refreshTable() {
            const response = await fetch('/list_cert_partical');
            const html = await response.text();
            document.getElementById('list-cert').innerHTML = html;
        }
    </script>
{% endblock %}
